server {
    listen 8889 ssl http2;
    listen [::]:8889 ssl http2;
    server_name _;
    
    root /var/www/html/public;
    index index.php index.html;
    rewrite ^/$ /login redirect;
    
    # ไม่จำกัดขนาดไฟล์อัพโหลด
    client_max_body_size 0;
    
    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/silo-hci.crt;
    ssl_certificate_key /etc/nginx/ssl/silo-hci.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Logging
    access_log /var/log/nginx/silo-access.log;
    error_log /var/log/nginx/silo-error.log;
    
    # Proxy Proxmox noVNC static assets (the native console references /novnc/*)
    # Place BEFORE the generic static files rule so it takes precedence
    location ^~ /novnc/ {
        proxy_pass https://192.168.0.200:8006/novnc/;
        proxy_set_header Host 192.168.0.200:8006;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Referer https://192.168.0.200:8006/;
        proxy_set_header Origin https://192.168.0.200:8006;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_ssl_name 192.168.0.200;
        proxy_ssl_verify off;
        proxy_buffering off;
    }

    # Proxy Proxmox API for native console (the page calls /api2/json/... directly)
    # Include WebSocket headers for /api2/json/.../vncwebsocket
    location ^~ /api2/ {
        proxy_pass https://192.168.0.200:8006/api2/;

        proxy_set_header Host 192.168.0.200:8006;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Referer https://192.168.0.200:8006/;
        proxy_set_header Origin https://192.168.0.200:8006;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_ssl_name 192.168.0.200;
        proxy_ssl_verify off;

        # Forward client cookies (PVEAuthCookie)
        proxy_set_header Cookie $http_cookie;

        # WebSocket upgrade
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;

        proxy_read_timeout 86400;
        proxy_buffering off;
    }

    # Static files (local app assets)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Root location fallback
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Favicon alias to existing SVG to avoid 404 noise in console tab
    location = /favicon.ico {
        alias /var/www/html/public/assets/images/favicon.svg;
    }

    # Dashboard alias
    location /dashboard {
        try_files $uri $uri/ /index.php?url=dashboard;
    }

    # Nodes alias
    location /nodes {
        try_files $uri $uri/ /index.php?url=nodes;
    }

    # VMs alias
    location /vms {
        try_files $uri $uri/ /index.php?url=vms;
    }

    # Containers alias
    location /containers {
        try_files $uri $uri/ /index.php?url=containers;
    }

    # Storage alias
    location /storage {
        try_files $uri $uri/ /index.php?url=storage;
    }

    # Network alias
    location /network {
        try_files $uri $uri/ /index.php?url=network;
    }

    # Backup alias
    location /backup {
        try_files $uri $uri/ /index.php?url=backup;
    }
    
    # PHP handling
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS on;
        include fastcgi_params;
        fastcgi_read_timeout 300;
    }
    
    # API proxy to backend
    location /api/ {
        proxy_pass http://backend:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        # เพิ่ม timeout สำหรับ upload ไฟล์ใหญ่
        proxy_read_timeout 7200;
        proxy_connect_timeout 7200;
        proxy_send_timeout 7200;
        # ไม่จำกัดขนาดไฟล์อัพโหลดสำหรับ API
        client_max_body_size 0;
        client_body_timeout 7200;
    }

    # Same-origin proxy to Proxmox API/WebSocket (prevents browser TLS trust issues)
    # NOTE: Adjust upstream host/port to match config/proxmox.json if different
    location /pve/ {
        # Proxmox upstream (HTTPS)
        proxy_pass https://192.168.0.200:8006/;

        # Upstream should see Proxmox host to avoid origin/host checks and enable SNI
        proxy_set_header Host 192.168.0.200:8006;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Referer https://192.168.0.200:8006/;
        proxy_set_header Origin https://192.168.0.200:8006;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_ssl_name 192.168.0.200;

        # Forward ALL client cookies (this is essential for VNC auth to work)
        proxy_set_header Cookie $http_cookie;

        # WebSocket upgrade headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        # Always upgrade the connection for WebSocket
        proxy_set_header Connection "upgrade";
    proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
    proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
    proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
    proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;

        # Long-lived connections
        proxy_read_timeout 86400;

        # Accept upstream self-signed cert
        proxy_ssl_verify off;
        proxy_buffering off;
    }

    # Proxy CDN assets to same-origin to avoid CORS for ESM imports (e.g., noVNC)
    location ^~ /cdn/ {
        proxy_pass https://unpkg.com/;
        proxy_set_header Host unpkg.com;
        proxy_http_version 1.1;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_read_timeout 300;
        # Cache-friendly headers passthrough
        proxy_hide_header Access-Control-Allow-Origin;
    }

    # noVNC 1.2.0 expects '../../app/ui.js' from core/input/keyboard.js
    # Provide a minimal local stub to satisfy the import
    location = /cdn/novnc@1.2.0/app/ui.js {
        alias /var/www/html/public/assets/js/novnc-ui-stub.js;
        default_type application/javascript;
        add_header Cache-Control "public, max-age=31536000";
    }

    

    # Health check endpoint
    location /health {
        proxy_pass http://backend:5000/health;
        access_log off;
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
    }
    
    location ~ /(config|vendor|src)/.*\.php$ {
        deny all;
    }
}
