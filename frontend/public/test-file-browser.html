<!DOCTYPE html>
<html>
<head>
    <title>File Browser Test</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 8px; width: 600px; max-height: 80vh; overflow: auto; }
        .modal-header { margin-bottom: 20px; font-size: 20px; font-weight: bold; }
        .modal-body { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f0f0f0; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .log { background: #222; color: #0f0; font-family: monospace; padding: 20px; margin: 20px 0; min-height: 300px; max-height: 400px; overflow: auto; font-size: 12px; border-radius: 4px; }
        .log-item { margin: 2px 0; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <h1>üß™ File Browser Test</h1>
    
    <div>
        <button onclick="testModal()">1. Test Modal Display</button>
        <button onclick="testAPI()">2. Test API Fetch</button>
        <button onclick="testFullFlow()">3. Test Full Flow</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">üìÅ File Browser</div>
            <div class="modal-body">
                <table id="fileTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="fileList">
                        <tr><td colspan="2">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="log" class="log"></div>

    <script>
        const API_URL = 'https://192.168.0.200:8889/api/v1';
        
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const color = type === 'success' ? '#0f0' : type === 'error' ? '#f00' : '#0ff';
            const html = `<div class="log-item" style="color: ${color};">${new Date().toLocaleTimeString()} | ${msg}</div>`;
            logEl.innerHTML += html;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testModal() {
            log('=== TESTING MODAL DISPLAY ===', 'info');
            const modal = document.getElementById('modal');
            log('1. Getting modal element...', 'info');
            if (!modal) {
                log('‚ùå Modal element not found', 'error');
                return;
            }
            log('‚úÖ Modal found', 'success');

            log('2. Adding .active class...', 'info');
            modal.classList.add('active');
            log('‚úÖ Class added', 'success');

            const computedStyle = window.getComputedStyle(modal);
            log(`3. Computed display: ${computedStyle.display}`, computedStyle.display === 'flex' ? 'success' : 'error');
            log(`   Computed position: ${computedStyle.position}`, 'info');
            log(`   Computed z-index: ${computedStyle.zIndex}`, 'info');
            
            setTimeout(() => {
                modal.classList.remove('active');
                log('‚úÖ Modal hidden', 'success');
            }, 2000);
        }

        async function testAPI() {
            log('=== TESTING API ===', 'info');
            const url = `${API_URL}/nodes/silo1/browse-directory`;
            log(`Fetching: ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: '/mnt' })
                });
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log('‚úÖ JSON parsed', 'success');
                log(`Response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
                
                if (data.success && data.data) {
                    log(`Found ${data.data.length} items:`, 'success');
                    data.data.forEach((item, i) => {
                        log(`  [${i}] ${item.name} (${item.type})`, 'success');
                    });
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        async function testFullFlow() {
            log('=== TESTING FULL FLOW ===', 'info');
            
            // Step 1: Show modal
            log('Step 1: Showing modal...', 'info');
            const modal = document.getElementById('modal');
            modal.classList.add('active');
            
            // Step 2: Fetch data
            log('Step 2: Fetching data...', 'info');
            try {
                const response = await fetch(`${API_URL}/nodes/silo1/browse-directory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: '/mnt' })
                });
                
                const data = await response.json();
                log(`‚úÖ Got ${data.data.length} items`, 'success');
                
                // Step 3: Render table
                log('Step 3: Rendering table...', 'info');
                const tbody = document.getElementById('fileList');
                tbody.innerHTML = data.data.map(item => `
                    <tr>
                        <td>${item.is_dir ? 'üìÅ' : 'üìÑ'} ${item.name}</td>
                        <td>${item.type}</td>
                    </tr>
                `).join('');
                log(`‚úÖ Table rendered with ${data.data.length} rows`, 'success');
                
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        log('‚úÖ Page loaded. Click buttons to test.', 'success');
    </script>
</body>
</html>
